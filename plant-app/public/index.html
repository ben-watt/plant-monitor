<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Greenhouse monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.13.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.13.2/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.13.2/firebase-database.js"></script>
    <script defer src="/__/firebase/7.13.2/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.13.2/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script defer src="https://d3js.org/d3.v5.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      body {
        overflow-x: hidden;
        font-weight: 300;
        background-color: white;
      }

      #app {
        --pageIndex: 0;
        display: flex;
      }

      .page-icons {
        display: flex;
        justify-content: center;
        position: fixed;
        bottom: 0px;
        width: 100%;
      }

      .page-icon {
        margin: 5px 3px 5px 3px;
        border-radius: 1em;
        width: 5px;
        height: 5px;
        border: 1px solid grey;
      }

      .page-icon.active {
        background-color: grey;
      }

      .page {
        min-width: 100%;
        min-height: 100vh;     
        transform: translate(calc(var(--pageIndex)*-100%));
        transition-duration: 50ms;
      }

      #container {
        position: relative;
        background-image: linear-gradient(50deg, #0D38D1, #701872);
        color: white;
      }

      .headline-figures {
        display: flex;
        align-items: center;
        display: flex;
        justify-content: space-evenly;
        margin-top: 1em;
      }

      .headline-figure {
        font-size: 8em;
        z-index: 1;
      }

      .header-image {
        width: 15em;
        justify-self: flex-end;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
      }

      #battery > img {
        height: 0.9em;
      }

      .day-row {
        padding: 5px 15px 5px 15px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        cursor: pointer;
      }

      .day-row > div {
        padding: 10px;
      }

      #day-line {
        background-color: lightgrey;
        height: 1px;
      }

      .arrow {
        visibility: hidden;
        padding: 0px;
        width: 5px;
        height: 5px;
        border-bottom: 1px solid grey;
        border-left: 1px solid grey;
        transform: rotate(45deg);
        transition-duration: 200ms;
        transition-property: visibility, transform;
      }

      .day-row.active .arrow {
        visibility: visible;
        transform: rotate(-45deg);
        transition-duration: 300ms;
      }

      .chart-container {
        visibility: hidden;
        height: 0em;
        box-shadow: inset 0px 0px 3px 1px grey;
        transition-duration: 300ms;
        overflow: hidden;
      }

      .day-row.active ~ .chart-container {
        display: block;
        visibility: visible;
        height: 10em;
        transition-duration: 300ms;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="page">
        <section id="container">
          <div class="header">
            <div id="last-reading">Thu Apr 09 2020 20:47:12 GMT+0100 (British Summer Time)</div>
            <div id="battery">
              <img src="./battery.svg"></img>
            </div>
          </div>
          <div class="headline-figures">
            <div id="temperature" class="headline-figure">27°</div>
            <img class="header-image" src="./camping-tent.svg"></img>
          </div>
        </section>
        <section id="history">
          <div class="day-row" onclick="openChart(this)">
            <div>Mon</div>
            <span id=day-line style="width: 100%"></span>
            <div>15°</div>
            <div>
              <div class="arrow"></div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="myChart" height="30em"></canvas>
          </div>
        </section>
      </div>
      <div class="page">
      </div>
      <div class="page-icons">
        <div class="page-icon active"></div>
        <div class="page-icon"></div>
      </div>
    </div>
    <script>

      function openChart(elm) {
        toggleClass(elm, "active");
      }

      function drawChart() {
        var ctx = document.getElementById("myChart").getContext("2d");
        var myLineChart = new Chart(ctx, {
            type: 'line',
            data: {
              datasets: [{
                data: [10, 20, 30, 40, 50, 60]
              }],
              labels: ['January', 'February', 'March', 'April', 'May', 'June']
            }
        });
      }

      function toggleClass(element, className) {
        if(!element.classList.contains(className)) {
          element.classList.add(className);
        } else {
          element.classList.remove(className);
        }
      }

      let pageManager = (function() {
        let app = document.getElementById('app');
        let pageIcons = document.getElementsByClassName("page-icon");

        app.addEventListener('left-swipe', function(ev) {
          app.style.setProperty('--pageIndex', 0);
          pageIcons[0].classList.add("active");
          pageIcons[1].classList.remove("active");
        })

        app.addEventListener('right-swipe', function(ev) {
          app.style.setProperty('--pageIndex', 1);
          pageIcons[1].classList.add("active");
          pageIcons[0].classList.remove("active");
        })

      })();

      let swipeHandler = (function swiper() {
        let touchStartPostionX = 0;
        let touchStartPositionY = 0;


        let app = document.getElementById('app');
        app.addEventListener('touchstart', swipe, false);
        app.addEventListener('touchend', swipe, false);

        function swipe(event) {
          if(event.type == 'touchstart') {
            touchStartPositionX = event.changedTouches[0].pageX;
            touchStartPositionY = event.changedTouches[0].pageY;
            return;
          }

          if(event.type == 'touchend') {
            var touchEndPositionX = event.changedTouches[0].pageX;
            var touchEndPositionY = event.changedTouches[0].pageY;

            var horisontalSwipe = touchStartPositionX - touchEndPositionX;
            var verticalSwipe = touchStartPositionY - touchEndPositionY;

            console.log(Math.abs(horisontalSwipe));

            if(Math.abs(verticalSwipe) > Math.abs(horisontalSwipe) 
              || Math.abs(horisontalSwipe) < 20) {
                return;
              }

            if(horisontalSwipe < 0) {
              app.dispatchEvent(new Event('left-swipe'));
            } else {
              app.dispatchEvent(new Event('right-swipe'));
            }

            touchStartPostionX = 0;
            touchStartPositionY = 0;
            return;
          }
        };

      })();

      var pageModel = function() {
        return {
          lastReading : {
            timeOfReading: "",
            humidity: "",
            temperature: ""
          },
          history: [
            {
              date: "",
              readings: [
                {
                  timeOfReading: "",
                  humidity: "",
                  temperature: "",
                },
                {
                  timeOfReading: "",
                  humidity: "",
                  temperature: "",
                }
              ]
            }
          ]
        }
      }


      
      var x = render(parentElement, pageModel);
      // return a load of functions that you can call on the page e.g. updateLastReading()
      // this function can only return the new state of last reading, it must be a pure function
      // so it shouldn't mutate state just return the new state
      // We can then create an id per function mark that to a container element <div/>
      // Then we can bind to the relevantly called function container and bind to all the elements
      // could use knockouts syntax "data-bind" which gives us a custom attribtue, or have some template
      // type syntax where the inner html is evaluated. e.g. {{timeOfReading}}
      // Not sure how you would bind to classes...

      document.addEventListener('DOMContentLoaded', function() {

        try {
          let app = firebase.app();
          var db = firebase.database();
          var data = db.ref("greenhouse/data").limitToLast(1);

          data.on('child_added', function(d) {

            var lastReading = document.getElementById("last-reading");
            //var humidity = document.getElementById("humidity");
            var temperature = document.getElementById("temperature");

            var reading = d.val();
            var res = parseReading(reading);
            lastReading.innerText = res.date;
            //humidity.innerText = res.humidity;
            temperature.innerText = res.temperature;

          });

          var history = db.ref("greenhouse/data").limitToLast(1000);
          var historyData = {};
          var dat = [];

          history.on('child_added', function(d) {
            var reading = d.val()
            var res = parseReading(reading);
            dat.push(res);            
          })

          console.log(res);

          dat.forEach(dataPoint => {
              var key = getKey(dataPoint);

              if(!historyData.hasOwnProperty(key)) 
              {
                historyData[key].highestTemperature = dataPoint.temperature;
              }

              if(historyData[key].highestTemperature < dataPoint.temperature)
              {
                historyData[key].highestTemperature = dataPoint.temperature;
              }

              if(historyData[key].highestHumidity < dataPoint.humidity)
              {
                historyData[key].highestHumidity = dataPoint.humidity;
              }
            });

          console.log(historyData);

        } catch (e) {
          console.error(e);
        }

        function getKey(date) {
          return date.getFullYear() + "." + date.getMonth() + "." + date.getDate();
        }

        function sameDay(d1, d2) {
          return d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();
        }

        function parseReading(reading) {
          return {
            date: new Date(reading.epoch_time * 1000),
            humidity: reading.humidity.toFixed(0),
            temperature: reading.temperature.toFixed(0)
          }
        }
      });
    </script>
  </body>
</html>
